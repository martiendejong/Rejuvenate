@using RejuvenatingExample.Models
@model IEnumerable<Game>

@{
    ViewBag.Title = "Homepage";
}

<h2>Homepage</h2>

<div id="items">
    @foreach (var game in Model)
    {
        var id = "item" + game.Id;
        <p id="@id">
            @game.Host (@game.Players.Count())
        </p>
    }
</div>

<input type="button" onclick="hostGame()" value="Host Game" />

@section  scripts
     {
    <!--Script references. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">

        var myHub;

        function hostGame()
        {
            myHub.server.hostGame();
        }

        $(function () {
            // Declare a proxy to reference the hub.
            myHub = $.connection.exampleHub;

            myHub.client.itemsAdded = function (type, rejuvenatorId, items)
            {
                items.forEach(function (item, index)
                {
                    var html = "<p id='item" + item.Id + "'>" + item.Host + " (" + item.Players.length + ")</p>";
                    $("#items").append(html);
                });
            }

            myHub.client.itemsRemoved = function (type, rejuvenatorId, items) {
                items.forEach(function (item, index)
                {
                    var selector = "#item" + item.Id;
                    $(selector).remove();
                });
            }

            myHub.client.itemsUpdated = function (type, rejuvenatorId, items) {
                items.forEach(function (item, index)
                {
                    var selector = "#item" + item.Id;
                    $(selector).text(item.Name);
                });
            }

            // Start the connection.
            $.connection.hub.start().done(function () {
                // todo make this safe and use a token so it cant be meddled with
                myHub.server.registerRejuvenatingClient([@ViewBag.rejuvenatorId]);
                myHub.server.setUser("@ViewBag.UserEmail");
            });
        });

    </script>

}